# API File Processing — Local Setup Guide

A tiny Flask API that:
- Authenticates requests per customer (ID + Bearer token)
- Accepts CSV/JSON uploads and stores the actual file as `<uuid>.<ext>` in `uploads/<customer_id>/`
- Tracks uploads in a DB with status (`Processing`, `Processed`, `Errored`)
- Generates a mock "processed" artifact in `uploads/<customer_id>/processed/` and serves it via `/get-results`
- Lets you check an upload’s status via `/file-status/<uuid>`

---

## 1) Requirements

- Python 3.8+


## 2) Create & activate a virtualenv

python3 -m venv .venv

source .venv/bin/activate

pip install -r requirements.txt

## 4) Configuration
Copy contents of .env.example in .env for local

## 5) Init the database (migrations)
flask db upgrade

## 6) Seed two customers (to get tokens)
python seed_customers.py "Customer One" "Customer Two"

You’ll see output like:
```
- id=1 name='Customer One' token='Kf1...xY'
- id=2 name='Customer Two' token='Qp2...9Z'
```

Keep one token handy for testing.

---

## 7) Run the server
flask run

Health check:
GET http://127.0.0.1:5000/health

## 8) Test the upload + results


### Upload CSV (multipart form)
curl -X POST http://127.0.0.1:5000/upload-file \
  -H "X-Customer-Id: 1" \
  -H "Authorization: Bearer <TOKEN_FROM_SEED>" \
  -F "file=@sample.csv"
```

Response example:
```json
{
  "message": "File uploaded",
  "file": {
    "uuid": "fdc44e67-7741-4b11-9ab7-8f95ae5cd8a6",
    "file_name": "sample.csv",
    "stored_as": "fdc44e67-7741-4b11-9ab7-8f95ae5cd8a6.csv",
    "status": "Processing",
    "customer_id": 1
  }
}
```

Copy the `uuid` (this is the **parent** file’s UUID).

### Get processed result
```bash
curl -X GET "http://127.0.0.1:5000/get-results?uuid=<PARENT_UUID>" \
  -H "X-Customer-Id: 1" \
  -H "Authorization: Bearer <TOKEN_FROM_SEED>" -OJ
```

This will:
- Create a mock processed artifact if missing at `uploads/1/processed/<processed_uuid>.csv`
- Download a friendly filename like `sample_processed.csv`

### Check status of an upload
```bash
curl -X GET http://127.0.0.1:5000/file-status/<PARENT_UUID> \
  -H "X-Customer-Id: 1" \
  -H "Authorization: Bearer <TOKEN_FROM_SEED>"
```

Response:
```json
{"uuid":"...","status":"Processing","file_name":"sample.csv","customer_id":1,"timestamp":"..."}
```

---

## 9) Auth details (every protected endpoint)
Send **both** headers:
- `X-Customer-Id: <int>`
- `Authorization: Bearer <customer_token>`

Tokens are generated by `seed_customers.py` and stored in the `customers` table.

---

## 10) API quick reference

- `GET /health` → `{ "status": "ok" }`
- `POST /upload-file`  
  Headers: `X-Customer-Id`, `Authorization: Bearer ...`  
  Body: `multipart/form-data` (`file`), or `application/json`, or raw `text/csv`
- `GET /file-status/<uuid>`  
  Headers: `X-Customer-Id`, `Authorization: Bearer ...`
- `GET /get-results?uuid=<parent_uuid>`  
  Headers: `X-Customer-Id`, `Authorization: Bearer ...`  
  Returns the processed artifact as an attachment.
